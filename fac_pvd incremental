{{
    config(
        materialized='incremental',
        unique_key = ['entitysystemid', 'account_number', 'mrn']
        )
}}

with pvd as (

    select * from {{ ref("stg_patient_visit_detail") }}
    {% if is_incremental() %}
      -- this filter will only be applied on an incremental run
      -- (uses >= to include records arriving later on the same day as the last run of this model)
      where file_processed_date >= (select coalesce(max(file_processed_date), '1900-01-01') from {{ this }})

    {% endif %}
)

select  {{ dbt_utils.generate_surrogate_key( ['core_facility_id', 'account_number', 'mrn']) }} patientvisitdetail_id,
       ces.entitysystemid,
        core_facility_id,
       process_type,
       mrn,
       account_number,
       arrival_method,
       hospital_name,
       unit_last,
       chief_complaint,
       primary_diagnosis,
       secondary_diagnosis,
       patient_age,
       triage_provider,
       original_provider_name,
       original_provider_npi,
       disposition_provider,
       disposition_provider_npi,
       admit_inpatient_datetime,
       admit_location,
       admit_observation_datetime,
       observation_location,
       disposition,
       disposition_location,
       arrival_datetime,
       registration_datetime,
       admit_datetime,
       triage_datetime,
       roomed_datetime,
       physician_initial_encounter_datetime,
       disposition_decision_datetime,
       departure_datetime,
       discharge_datetime,
       acuity_score,
       file_name,
       file_processed_date,
       patient_gender,
       admit_decision_datetime
from (
    select *,
           row_number() over (partition by core_facility_id, account_number, mrn order by departure_datetime desc) rn
    from pvd
     ) x
inner join ( {{ ref("cfg_entitysystem") }} ces
inner join {{ ref("cfg_system") }} cs on ces.systemid = cs.systemid
    and cs.refname = 'tbd')
on x.core_facility_id = ces.syskey
where x.rn = 1
